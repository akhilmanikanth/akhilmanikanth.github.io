<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>DCT's — Universal Tool</title>
    <!-- Libraries (CDN, browser-only) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --panel: rgba(255, 255, 255, 0.95);
            --panel-dark: rgba(255, 255, 255, 0.85);
            --ink: #1a202c;
            --muted: #4a5568;
            --stroke: rgba(226, 232, 240, 0.8);
            --brand: #4f46e5;
            --brand2: #06b6d4;
            --brand3: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --grad: linear-gradient(135deg, var(--brand) 0%, var(--brand2) 50%, var(--brand3) 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--ink);
            overflow-x: hidden;
        }

        .layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
            background: var(--panel);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--stroke);
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 20px;
            background: var(--panel-dark);
            backdrop-filter: blur(10px);
            border: 1px solid var(--stroke);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .brand:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--grad);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 18px;
            box-shadow: var(--shadow);
        }

        .brand-text {
            flex: 1;
        }

        .brand-title {
            font-weight: 800;
            font-size: 16px;
            color: var(--ink);
            margin-bottom: 2px;
        }

        .brand-subtitle {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }

        .me {
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
        }

        .ribbon {
            background: var(--grad);
            color: white;
            font-weight: 800;
            padding: 16px 20px;
            border-radius: 16px;
            text-align: center;
            font-size: 14px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .ribbon::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .ribbon:hover::before {
            left: 100%;
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav a {
            padding: 14px 16px;
            border-radius: 16px;
            cursor: pointer;
            color: var(--muted);
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.1), transparent);
            transition: left 0.3s;
        }

        .nav a:hover {
            background: rgba(79, 70, 229, 0.05);
            border-color: rgba(79, 70, 229, 0.2);
            transform: translateX(4px);
            color: var(--brand);
        }

        .nav a:hover::before {
            left: 100%;
        }

        .nav a.active {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(139, 92, 246, 0.1));
            border-color: rgba(79, 70, 229, 0.3);
            color: var(--brand);
            font-weight: 600;
            box-shadow: var(--shadow);
        }

        .nav-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        .main {
            padding: 32px 40px 60px;
            background: transparent;
            position: relative;
        }

        .main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="20" cy="80" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
            z-index: 1;
        }

        .main > * {
            position: relative;
            z-index: 2;
        }

        /* Logo positioning in top right */
        .logo-container {
            position: absolute;
            top: 24px;
            right: 32px;
            z-index: 50;
            border-radius: 20px;
            box-shadow: none;
            transition: none;
        }
        
        /* Adjusted to be a circular container with the image as a mask, to handle transparency */
        .logo-container {
            background: transparent;
            padding: 0;
            overflow: visible;
        }

        .logo-container img {
            width: 90px;
            height: 90px;
            object-fit: contain;
            border-radius: 0;
            transition: all 0.3s ease;
        }
        
        .logo-container:hover {
            transform: none;
            box-shadow: none;
            background: transparent;
        }
        
        .logo-container:hover img {
            transform: scale(1.05);
        }

        .title {
            font-size: 36px;
            font-weight: 900;
            margin: 0 0 8px 0;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            margin: 0 0 32px 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            font-weight: 500;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            gap: 24px;
        }

        .card {
            grid-column: span 12;
            background: var(--panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--stroke);
            border-radius: 24px;
            padding: 0;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--stroke);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(139, 92, 246, 0.05));
            font-weight: 700;
            font-size: 16px;
            color: var(--ink);
        }

        .card-content {
            padding: 24px;
        }

        .stack {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .help {
            color: var(--muted);
            font-size: 14px;
            font-weight: 500;
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 20px;
        }

        .kpi .card {
            padding: 24px;
            text-align: center;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
        }

        .kpi .v {
            font-size: 32px;
            font-weight: 900;
            background: var(--grad);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 8px;
        }

        .kpi .t {
            font-size: 13px;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .log {
            white-space: pre-wrap;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: #e2e8f0;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 20px;
            height: 200px;
            overflow: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border: 1px solid var(--stroke);
            border-radius: 20px;
            color: var(--muted);
            font-size: 12px;
            font-weight: 600;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .badge.ok {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .badge.warn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: #f59e0b;
            color: white;
            box-shadow: var(--shadow-sm);
        }

        button {
            background: linear-gradient(135deg, var(--ink), #2d3748);
            border: none;
            color: white;
            font-weight: 700;
            border-radius: 16px;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        button:hover::before {
            left: 100%;
        }

        button.secondary {
            background: linear-gradient(135deg, var(--brand2), #0891b2);
        }

        button.alt {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: var(--shadow);
        }

        input[type=file], input[type=date] {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--stroke);
            color: var(--ink);
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        input[type=file]:focus, input[type=date]:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .drop {
            border: 2px dashed rgba(79, 70, 229, 0.3);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(139, 92, 246, 0.05));
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .drop::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .drop:hover::before {
            transform: translateX(100%);
        }

        .drop.dragover {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(139, 92, 246, 0.1));
            border-color: var(--brand);
            transform: scale(1.02);
        }

        .drop-title {
            font-weight: 700;
            color: var(--ink);
            margin-bottom: 4px;
        }

        .mini {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .overlay .box {
            width: min(500px, 90vw);
            background: var(--panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--stroke);
            border-radius: 24px;
            padding: 32px;
            box-shadow: var(--shadow-xl);
            text-align: center;
        }

        .loader {
            height: 12px;
            background: rgba(226, 232, 240, 0.3);
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
        }

        .bar {
            height: 100%;
            width: 0;
            background: var(--grad);
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        .progress-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }

        .truck {
            font-size: 24px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .sidebar-help {
            margin-top: auto;
            padding: 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border-radius: 16px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            text-align: center;
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid var(--stroke);
            border-radius: 12px;
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: rgba(255,255,255,0.8);
            transform: translateX(4px);
        }

        .history-name {
            font-weight: 600;
            color: var(--ink);
        }

        .history-time {
            font-size: 11px;
            color: var(--muted);
            font-weight: 500;
        }

        @media (max-width: 1024px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                height: auto;
            }

            .kpi {
                grid-template-columns: 1fr;
            }

            .main {
                padding: 24px 20px 40px;
            }

            .title {
                font-size: 28px;
            }

            .logo-container {
                top: 16px;
                right: 20px;
            }

            .logo-container img {
                width: 70px;
                height: 70px;
            }
        }

        /* Chart container styling */
        .chart-container {
            position: relative;
            height: 200px;
            padding: 20px;
        }

        /* About section styling */
        .about-content {
            font-size: 18px;
            line-height: 1.8;
            color: var(--ink);
            font-weight: 500;
        }

        .about-highlight {
            background: var(--grad);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        /* Animation for cards */
        .card {
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stagger animation for multiple cards */
        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        .card:nth-child(4) { animation-delay: 0.4s; }
    </style>
<script async src="https://bolt.new/badge.js?s=391922a9-fcac-4168-a114-0da21aeccef4"></script></head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <div class="logo">D</div>
                <div class="brand-text">
                    <div class="brand-title">Akhil's DCT</div>
                    <div class="brand-subtitle">Universal Tool</div>
                </div>
                <span class="me">Pro</span>
            </div>
            <div class="ribbon">DCT Dashboard</div>
            <nav class="nav" id="nav">
                <a data-target="dashboard" class="active">
                    <span class="nav-icon">🏠</span>
                    <span>Dashboard</span>
                </a>
                <a data-target="convert">
                    <span class="nav-icon">🧱</span>
                    <span>Convert & Merge</span>
                </a>
                <a data-target="weekly">
                    <span class="nav-icon">📅</span>
                    <span>Weekly Summary</span>
                </a>
                <a data-target="logs">
                    <span class="nav-icon">🧾</span>
                    <span>Activity Logs</span>
                </a>
                <a data-target="about">
                    <span class="nav-icon">ℹ️</span>
                    <span>About</span>
                </a>
            </nav>
            <div class="sidebar-help">
                🔒 100% browser‑only<br>
                Files stay on your machine
            </div>
        </aside>

        <!-- Main -->
        <main class="main">
            <!-- Logo in top right corner -->
            <div class="logo-container">
                <img src="https://login.geotester.com/geotester/reports/futureGeneration.png" alt="Geotester Logo" />
            </div>

            <h1 class="title">DCT's Universal Tool</h1>
            <p class="subtitle"><b>Convert Quest to Boral & Generate Weekly Summary Reports in Seconds</b></p>

            <!-- Dashboard -->
            <section id="dashboard" class="stack">
                <div class="grid">
                    <div class="card" style="grid-column: span 12">
                        <div class="card-header">
                            <strong>📊 Performance Overview</strong>
                            <span class="badge">Real-time Analytics</span>
                        </div>
                        <div class="card-content">
                            <div class="kpi">
                                <div class="card">
                                    <div class="v" id="kpi-rows">0</div>
                                    <div class="t">Rows Processed</div>
                                </div>
                                <div class="card">
                                    <div class="v" id="kpi-last">—</div>
                                    <div class="t">Last Export</div>
                                </div>
                                <div class="card">
                                    <div class="v" id="kpi-files">0</div>
                                    <div class="t">Files Generated</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: span 7">
                        <div class="card-header">
                            <strong>📈 Concrete vs Grout Analysis</strong>
                            <span class="badge ok">Live Updates</span>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="chart-cg"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: span 5">
                        <div class="card-header">
                            <strong>📋 Export History</strong>
                            <button id="btn-clear-history" class="badge">Clear All</button>
                        </div>
                        <div class="card-content">
                            <div id="history" class="stack"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Convert & Merge -->
            <section id="convert" class="stack" style="display:none">
                <div class="grid">
                    <!-- Concrete -->
                    <div class="card" style="grid-column: span 6">
                        <div class="card-header">
                            <strong>🏗️ Concrete Processing</strong>
                            <span class="badge warn" id="b-cyl">Waiting for files</span>
                        </div>
                        <div class="card-content">
                            <div class="stack">
                                <div class="drop" id="drop-cyl">
                                    <div class="drop-title">📄 Concrete Summary – One Line per Cylinder</div>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-cyl" type="file" accept=".csv,.xlsx,.xls" style="display:none"/>
                                </div>
                                <div class="drop" id="drop-field">
                                    <div class="drop-title">📊 Concrete Field Summary</div>
                                    <span class="badge warn" id="b-field">Required</span>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-field" type="file" accept=".csv,.xlsx,.xls" style="display:none"/>
                                </div>
                                <div class="row">
                                    <button id="btn-conc" class="alt" disabled>
                                        ⬇️ Generate Concrete_Boral.xlsx
                                    </button>
                                </div>
                                <div class="help">Transform Geotester's Concrete data into Boral-compatible format</div>
                            </div>
                        </div>
                    </div>

                    <!-- Grout -->
                    <div class="card" style="grid-column: span 6">
                        <div class="card-header">
                            <strong>🧪 Grout Processing</strong>
                            <span class="badge warn" id="b-cube">Waiting for files</span>
                        </div>
                        <div class="card-content">
                            <div class="stack">
                                <div class="drop" id="drop-cube">
                                    <div class="drop-title">📋 Grout — One Line per Cube</div>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-cube" type="file" accept=".csv,.xlsx,.xls" style="display:none"/>
                                </div>
                                <div class="drop" id="drop-gse">
                                    <div class="drop-title">📈 Grout Summary Export</div>
                                    <span class="badge" id="b-gse">Optional</span>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-gse" type="file" accept=".csv,.xlsx,.xls" style="display:none"/>
                                </div>
                                <div class="row">
                                    <button id="btn-grout" class="secondary" disabled>
                                        ⬇️ Generate Grout_Boral.xlsx
                                    </button>
                                </div>
                                <div class="help">Transform Geotester's Grout data into Boral-compatible format</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <strong>🔍 Processing Activity Log</strong>
                    </div>
                    <div class="card-content">
                        <div class="log" id="logA">🚀 System ready for processing...</div>
                    </div>
                </div>
            </section>

            <!-- Weekly -->
            <section id="weekly" class="stack" style="display:none">
                <div class="grid">
                    <div class="card" style="grid-column: span 4">
                        <div class="card-header">
                            <strong>📁 Boral Files Upload</strong>
                        </div>
                        <div class="card-content">
                            <div class="stack">
                                <div class="drop" id="drop-boralc">
                                    <div class="drop-title">Concrete_Boral.xlsx</div>
                                    <span class="badge" id="b-boralc">No file selected</span>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-boralc" type="file" accept=".xlsx,.xls" style="display:none;"/>
                                </div>
                                <div class="drop" id="drop-boralg">
                                    <div class="drop-title">Grout_Boral.xlsx</div>
                                    <span class="badge" id="b-boralg">No file selected</span>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-boralg" type="file" accept=".xlsx,.xls" style="display:none;"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: span 4">
                        <div class="card-header">
                            <strong>🏗️ Site-Specific Files</strong>
                        </div>
                        <div class="card-content">
                            <div class="stack">
                                <div class="drop" id="drop-lobs">
                                    <div class="drop-title">Lobs Hole – All Samples</div>
                                    <span class="badge" id="b-lobs">Optional</span>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-lobs" type="file" accept=".csv,.xlsx,.xls" style="display:none;"/>
                                </div>
                                <div class="drop" id="drop-polo">
                                    <div class="drop-title">Polo Flat – All Samples</div>
                                    <span class="badge" id="b-polo">Optional</span>
                                    <div class="mini">Drop file here or click to browse</div>
                                    <input id="f-polo" type="file" accept=".csv,.xlsx,.xls" style="display:none;"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: span 4">
                        <div class="card-header">
                            <strong>📅 Date Range Filter</strong>
                        </div>
                        <div class="card-content">
                            <div class="stack">
                                <div class="row" style="gap: 12px;">
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--muted);">START DATE</label>
                                        <input id="b-start" type="date"/>
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--muted);">END DATE</label>
                                        <input id="b-end" type="date"/>
                                    </div>
                                </div>
                                <button id="btn-weekly" class="alt">
                                    🚀 Generate Weekly Reports
                                </button>
                                <div class="help">
                                    Outputs: <code>All_Sites_Main_Data.xlsx</code> and <code>Temperature_Extract.xlsx</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <strong>📊 Weekly Processing Log</strong>
                    </div>
                    <div class="card-content">
                        <div class="log" id="logB">📋 Weekly report system ready...</div>
                    </div>
                </div>
            </section>

            <!-- Logs -->
            <section id="logs" class="stack" style="display:none">
                <div class="grid">
                    <div class="card" style="grid-column: span 6">
                        <div class="card-header">
                            <strong>🔄 Convert & Merge Activity</strong>
                        </div>
                        <div class="card-content">
                            <div class="log" id="logA_mirror">📝 Conversion activity will appear here...</div>
                        </div>
                    </div>
                    <div class="card" style="grid-column: span 6">
                        <div class="card-header">
                            <strong>📈 Weekly Report Activity</strong>
                        </div>
                        <div class="card-content">
                        <div class="log" id="logB_mirror">📊 Weekly report activity will appear here...</div>
                    </div>
                </div>
            </section>

            <!-- About -->
            <section id="about" class="stack" style="display:none">
                <div class="card">
                    <div class="card-header">
                        <strong>ℹ️ About DCT's Universal Tool</strong>
                    </div>
                    <div class="card-content">
                        <div class="about-content">
                            🚀 Engineered by <span class="about-highlight">Akhil Manikanth</span>, this cutting-edge
                            <span class="about-highlight">Universal Dashboard</span> revolutionizes DCT's workflow with
                            lightning-fast <strong>Quest → Boral</strong> conversions and intelligent weekly report generation.
                            <br><br>
                            Built with modern web technologies including <span class="about-highlight">Chart.js</span> and
                            <span class="about-highlight">XLSX.js</span>, this tool delivers enterprise-grade performance
                            while maintaining complete data privacy through 100% browser-based processing.
                            <br><br>
                            Features include advanced data mapping, intelligent source code inference, temperature extraction,
                            and comprehensive analytics — all wrapped in a beautiful, responsive interface designed for
                            <span class="about-highlight">speed</span>, <span class="about-highlight">elegance</span>,
                            and <span class="about-highlight">efficiency</span>.
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay">
        <div class="box">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
                <strong style="font-size: 18px; font-weight: 700;">Processing Data...</strong>
                <span class="truck">🚚</span>
            </div>
            <div class="loader">
                <div class="bar" id="bar"></div>
            </div>
            <div class="progress-row">
                <small id="progress-text" style="color: var(--muted); font-weight: 500;">Initializing...</small>
            </div>
        </div>
    </div>

    <script>
        /* ================= Navigation (works on click) ================= */
        const sections = ['dashboard','convert','weekly','logs','about'];
        const nav = document.getElementById('nav');

        function showSection(target){
            sections.forEach(id=>{
                const el=document.getElementById(id);
                if(el) el.style.display = (id===target?'block':'none');
            });
            [...nav.querySelectorAll('a')].forEach(a=>
                a.classList.toggle('active', a.dataset.target===target));

            // mirror logs
            const la = document.getElementById('logA_mirror');
            const lb = document.getElementById('logB_mirror');
            if(la){
                la.textContent = document.getElementById('logA').textContent;
            }
            if(lb){
                lb.textContent = document.getElementById('logB').textContent;
            }
        }

        nav.addEventListener('click', (e)=>{
            const a = e.target.closest('a[data-target]');
            if(!a) return;
            e.preventDefault();
            showSection(a.dataset.target);
            history.replaceState(null, '', '#' + a.dataset.target);
        });

        const initial = (location.hash||'#dashboard').slice(1);
        showSection(sections.includes(initial)?initial:'dashboard');

        /* ================= KPI + Chart + History ================= */
        const state = {
            processedRows:0,
            filesExported:0,
            lastExport:'—',
            concreteCount:0,
            groutCount:0
        };

        const elRows = document.getElementById('kpi-rows');
        const elFiles = document.getElementById('kpi-files');
        const elLast = document.getElementById('kpi-last');
        const historyEl = document.getElementById('history');

        const chart = new Chart(document.getElementById('chart-cg').getContext('2d'),{
            type:'doughnut',
            data:{
                labels:['Concrete','Grout'],
                datasets:[{
                    data:[0,0],
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.8)',
                        'rgba(139, 92, 246, 0.8)'
                    ],
                    borderColor: [
                        'rgba(79, 70, 229, 1)',
                        'rgba(139, 92, 246, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options:{
                plugins:{
                    legend:{
                        position:'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                family: 'Inter',
                                size: 12,
                                weight: '600'
                            }
                        }
                    }
                },
                cutout:'60%',
                responsive:true,
                maintainAspectRatio:false
            }
        });

        function refreshKPI(){
            elRows.textContent = state.processedRows.toLocaleString();
            elFiles.textContent = state.filesExported.toString();
            elLast.textContent = state.lastExport;
            chart.data.datasets[0].data = [state.concreteCount, state.groutCount];
            chart.update();
        }

        function addHistory(name){
            const list = JSON.parse(localStorage.getItem('dct-history')||'[]');
            list.unshift({name, time:new Date().toLocaleString()});
            localStorage.setItem('dct-history', JSON.stringify(list.slice(0,6)));
            renderHistory();
        }

        function renderHistory(){
            const list = JSON.parse(localStorage.getItem('dct-history')||'[]');
            historyEl.innerHTML = list.length? '': '<div class="help">No exports yet — your generated files will appear here</div>';
            for(const item of list){
                const row = document.createElement('div');
                row.className = 'history-item';
                row.innerHTML = `
                    <div class="history-name">${item.name}</div>
                    <div class="history-time">${item.time}</div>
                `;
                historyEl.appendChild(row);
            }
        }

        renderHistory();
        document.getElementById('btn-clear-history').addEventListener('click', ()=>{localStorage.removeItem('dct-history'); renderHistory();});

        /* ================= Overlay / progress & confetti ================= */
        const overlay = document.getElementById('overlay');
        const bar = document.getElementById('bar');
        const progressText = document.getElementById('progress-text');

        function showOverlay(msg){
            overlay.style.display='flex';
            setProgress(0,msg||'Starting…');
        }

        function hideOverlay(){
            overlay.style.display='none';
        }

        function setProgress(p,msg){
            bar.style.width = Math.max(0,Math.min(100,p))+'%';
            if(msg) progressText.textContent = msg;
        }

        function celebrate(){
            const duration = 1000;
            const end = Date.now()+duration;
            (function frame(){
                confetti({
                    particleCount: 6,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 }
                });
                confetti({
                    particleCount: 6,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 }
                });
                if(Date.now()<end) requestAnimationFrame(frame);
            })();
        }

        /* ================= XLSX helpers & mapping (FIXED DATES & TEMPS) ================= */
        const BORAL_HEADERS = ["Date","Source Code","Docket","ClientName","ProjectName","PourNo","Lots","SampleID","Specimen ID","Type","Product Code","Date Batched","Time Sampled","Time Batched","Time Moulded","Date Tested","Age Days","Age Hours","Init Curing Hrs","Std Curing Days","Grade","Density","Mass Unit Vol","Dim1","Dim2","Load Size","Progress Load","Des slmp","Measured Slump","Second Slump","Avg Diameter","Avg Height","Strength","Compact Method","Measured Air","Concrete Temp","Ambient Temp","Failure Mode","Cap","Marks","Location Description","Truck","Remarks","Rounded Density (U)","Rounded MPUV (V)","Rounded Strength (AE)"];

        const TEMP_HEADERS = ["Date","Source Code","Docket","PourNo","Type","Product Code","Date Batched","Age Days","Concrete Temp","Ambient Temp","Location Description"];

        function sheetToRows_strings(file){
            return file.arrayBuffer().then(buf=>{
                const wb = XLSX.read(buf,{type:"array", cellDates:false});
                let best = {name: wb.SheetNames[0], rows:0};
                for(const n of wb.SheetNames){
                    const r = XLSX.utils.sheet_to_json(wb.Sheets[n],{defval:"", raw:false}).length;
                    if(r>best.rows) best={name:n, rows:r};
                }
                const ws = wb.Sheets[best.name];
                return XLSX.utils.sheet_to_json(ws,{defval:"", raw:false});
            });
        }

        function csvToRows_strings(file){
            return file.text().then(txt=>{
                const wb = XLSX.read(txt,{type:"string"});
                const ws = wb.Sheets[wb.SheetNames[0]];
                return XLSX.utils.sheet_to_json(ws,{defval:"", raw:false});
            });
        }

        function loadAny(file){
            if(!file) return Promise.resolve([]);
            return /\.csv$/i.test(file.name) ? csvToRows_strings(file) : sheetToRows_strings(file);
        }

        // FIXED: Temperature handling - return empty string for blank/zero values
        function numOrBlankTemp(v){
            const s=String(v??"").trim();
            if(!s || s === "0" || s === "0.0") return "";
            const n=Number(s.replace(/[^0-9.\-]/g,""));
            return (Number.isFinite(n) && n !== 0)?n:"";
        }

        function numOrBlank(v){
            const s=String(v??"").trim();
            if(!s || s === "0") return "";
            const n=Number(s.replace(/[^0-9.\-]/g,""));
            return Number.isFinite(n)?n:"";
        }

        function intOrBlank(v){
            const n=numOrBlank(v);
            return n===""?"":Math.round(n);
        }

        function round1OrBlank(v){
            const n=numOrBlank(v);
            return n===""?"":Math.round(n*10)/10;
        }

        function round10UpOrBlank(v){
            const n=numOrBlank(v);
            return n===""?"":Math.ceil(n/10)*10;
        }

        function getV(row, keys){
            for(const k of keys){
                if(k in row){
                    const v=row[k];
                    if(String(v).trim()!=="") return String(v);
                }
            }
            return "";
        }

        function first(...vals){
            for(const v of vals){
                const s=String(v??"").trim();
                if(s) return s;
            }
            return "";
        }

        function findTR(s){
            const m = String(s||"").match(/\bTR\s*\d+\b/i);
            return m? m[0].replace(/\s+/g," ").toUpperCase() : "";
        }

        function mapSourceCode(plant){
            const p = String(plant||"").trim().toLowerCase();
            if(p.startsWith("tantangara")) return "TAN";
            if(p.startsWith("marica")) return "MAR";
            if(p.startsWith("polo")) return "POLO";
            if(p.startsWith("lobs")) return "LOBS";
            return plant? String(plant).trim(): "";
        }

        // FIXED: Date normalization to always return DD/MM/YYYY format
        function normalizeToDMYString(val){
            if(val===undefined || val===null) return "";
            const s = String(val).trim();
            if(!s) return "";

            // Try DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY first (preferred format)
            let m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
            if(m){
                let dd=+m[1], mm=+m[2], yy=+m[3];
                if(yy<100) yy=2000+yy;
                
                // Validate it's a real date - if DD > 12, assume it's DD/MM, not MM/DD
                if(dd <= 12 && mm > 12) {
                    // Swap - this was MM/DD format, convert to DD/MM
                    [dd, mm] = [mm, dd];
                }
                
                const d=new Date(yy, mm-1, dd);
                if(!isNaN(d)&&d.getFullYear()===yy&&d.getMonth()===mm-1&&d.getDate()===dd){
                    return `${String(dd).padStart(2,"0")}/${String(mm).padStart(2,"0")}/${yy}`;
                }
                return "";
            }

            // Try YYYY/MM/DD or YYYY-MM-DD format
            m = s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
            if(m){
                let yy=+m[1], mm=+m[2], dd=+m[3];
                const d=new Date(yy, mm-1, dd);
                if(!isNaN(d)&&d.getFullYear()===yy&&d.getMonth()===mm-1&&d.getDate()===dd){
                    return `${String(dd).padStart(2,"0")}/${String(mm).padStart(2,"0")}/${yy}`;
                }
                return "";
            }

            // Excel serial number
            if(/^\d+(\.\d+)?$/.test(s)){
                const n=Number(s);
                if(n > 1) { // Valid Excel date serial
                    const utc = Math.round((n - 25569) * 86400 * 1000);
                    const d=new Date(utc);
                    if(!isNaN(d)) {
                        return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
                    }
                }
            }

            return "";
        }

        function dmyStringToSerial(dmy){
            const m = dmy.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if(!m) return null;
            const dd=+m[1], mm=+m[2], yy=+m[3];
            const utc = Date.UTC(yy, mm-1, dd);
            return (utc - Date.UTC(1899,11,30)) / 86400000;
        }

        function dateFromDMYString(s){
            const m = String(s||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if(!m) return null;
            const dd=+m[1], mm=+m[2], yy=+m[3];
            const d=new Date(yy, mm-1, dd);
            if(d.getFullYear()===yy && d.getMonth()===(mm-1) && d.getDate()===dd) return d;
            return null;
        }

        function dateFromInput(value){
            if(!value) return null;
            const m = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if(!m) return null;
            const yy=+m[1], mm=+m[2], dd=+m[3];
            const d=new Date(yy, mm-1, dd);
            if(d.getFullYear()===yy && d.getMonth()===(mm-1) && d.getDate()===dd) return d;
            return null;
        }

        /* ===== Enhanced functions from standalone tool ===== */
        function parseTimeToFraction(v){
            if(v===undefined || v===null) return null;
            let s=String(v).trim();
            if(!s) return null;

            // Excel numeric fraction (0..1) or seconds
            if(/^[0-9]+(\.[0-9]+)?$/.test(s)){
                const n=Number(s);
                if(n>=0 && n<1) return n;
                if(n>1 && n<86400) return n/86400;
            }

            // 24h HH:MM[:SS]
            let m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
            if(m){
                const hh=+m[1], mm=+m[2], ss=+(m[3]||0);
                if(hh<24 && mm<60 && ss<60) return (hh*3600+mm*60+ss)/86400;
            }

            // 12h with AM/PM
            m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*([AP]M)$/i);
            if(m){
                let hh=+m[1], mm=+m[2], ss=+(m[3]||0);
                const ap=m[4].toUpperCase();
                if(ap==="PM" && hh<12) hh+=12;
                if(ap==="AM" && hh===12) hh=0;
                if(hh<24 && mm<60 && ss<60) return (hh*3600+mm*60+ss)/86400;
            }
            return null;
        }

        const MAP_EXTRA_LOBS=[/ECVT/i,/ECVT\s*Tunnel/i,/DT\s*0?4/i];
        const MAP_EXTRA_TAN=[/\bR18(4[1-9]|5[0-9]|60)\b/i,/\bR185[1-9]\b/i,/\bR1860\b/i,/\bTBM\b/i]; // R1841–R1860 + TBM
        const MAP_EXTRA_LOBS_MH=[/^MH-/i]; // starts with MH-

        function inferSourceFromText(txt){
            const t = String(txt||"");
            for(const rx of MAP_EXTRA_LOBS){
                if(rx.test(t)) return "LOBS";
            }
            for(const rx of MAP_EXTRA_LOBS_MH){
                if(rx.test(t)) return "LOBS";
            }
            for(const rx of MAP_EXTRA_TAN){
                if(rx.test(t)) return "TAN";
            }
            return "";
        }

        function inferSourceForAnyRow(row){
            const existing = String(row["Source Code"]||"").trim();
            if(existing) return existing;
            const loc=row["Location Description"]||"", rem=row["Remarks"]||"";
            const built=(loc+" "+rem).trim();
            const fromTxt=inferSourceFromText(built);
            if(fromTxt) return fromTxt;
            return "";
        }

        function propagateTRMappings(rows){
            const trToSC=new Map();
            for(const r of rows){
                const sc=String(r["Source Code"]||"").trim();
                const tr=findTR(r["Location Description"]||r["Remarks"]||"");
                if(sc && tr){
                    if(!trToSC.has(tr)) trToSC.set(tr, sc);
                }
            }
            let updates=0;
            for(const r of rows){
                if(String(r["Source Code"]||"").trim()) continue;
                const tr=findTR(r["Location Description"]||r["Remarks"]||"");
                if(tr && trToSC.has(tr)){
                    r["Source Code"]=trToSC.get(tr);
                    updates++;
                }
            }
            return updates;
        }

        function autoFillSourceCodesAll(rows){
            let filled=0;
            for(const r of rows){
                if(String(r["Source Code"]||"").trim()) continue;
                const inf=inferSourceForAnyRow(r);
                if(inf){
                    r["Source Code"]=inf;
                    filled++;
                }
            }
            filled+=propagateTRMappings(rows);
            return filled;
        }

        // FIXED: Date pivot function for filtering
        function getPivotDateDMY(row){
            const candidates=[row["Date"],row["Date Batched"],row["Date Tested"]];
            for(const c of candidates){
                const s=normalizeToDMYString(c);
                if(s){
                    const d=dateFromDMYString(s);
                    if(d) return d;
                }
            }
            return null;
        }

        function autoFillType(rows){
            const toBlank = v => (v==null ? "" : String(v).trim());
            let filled = 0;
            for (const r of rows){
                const currType = toBlank(r["Type"]);
                if (currType) continue; // leave existing values alone

                const pc = toBlank(r["Product Code"]).toLowerCase();
                const remarks = toBlank(r["Remarks"]).toLowerCase();
                const loc = toBlank(r["Location Description"]).toLowerCase();

                // Grout products
                if (pc.includes("infragrout") || pc.includes("master roc mg 01") || pc.includes("mono component")) {
                    r["Type"] = "GROCUBE";
                    filled++;
                    continue;
                }

                // Grout text clues
                if (remarks.includes("grout") || loc.includes("grout")) {
                    r["Type"] = "GROCUBE";
                    filled++;
                    continue;
                }

                // Concrete mix mappings
                if (pc === "mix - a - gp" || pc === "mix-a-gp") {
                    r["Type"] = "COMP100";
                    filled++;
                    continue;
                }
            }
            return filled;
        }
        
        // This function now correctly handles dates and times by setting the cell type
        function rowsToSheet_withTimeFix(rows){
            // 1) clone rows, set Date Batched = Date, normalize dates, and uppercase Source Code
            const out = rows.map(r=>{
                const z = {...r};
                if("Date" in z){
                    const s = normalizeToDMYString(z["Date"]);
                    if(s) z["Date"] = s;
                    // enforce rule: Date Batched = Date
                    z["Date Batched"] = s || z["Date Batched"];
                }
                if("Date Tested" in z){
                    const sT = normalizeToDMYString(z["Date Tested"]);
                    if(sT) z["Date Tested"] = sT;
                }
                // normalize Source Code casing
                if (z["Source Code"]) {
                    z["Source Code"] = String(z["Source Code"]).trim().toUpperCase();
                }
                return z;
            });
            
            // 2) write sheet
            const ws = XLSX.utils.json_to_sheet(out, {defval:"", raw:true});

            // 3) convert times to real Excel times (hh:mm)
            const header = XLSX.utils.sheet_to_json(ws, {header:1})[0] || [];
            const timeCols = ["Time Sampled","Time Batched","Time Moulded"]
                .map(h => header.indexOf(h))
                .filter(i => i >= 0);

            if(ws['!ref'] && timeCols.length){
                const range = XLSX.utils.decode_range(ws['!ref']);
                for(const ci of timeCols){
                    for(let r=range.s.r+1; r<=range.e.r; r++){
                        const addr = XLSX.utils.encode_cell({r, c:ci});
                        const cell = ws[addr];
                        const raw = (cell && cell.v!=null) ? String(cell.v).trim() : "";
                        if(!raw){
                            ws[addr] = {t:'s', v:""};
                            continue;
                        }
                        const frac = parseTimeToFraction(raw);
                        ws[addr] = (frac==null) ? {t:'s', v:raw} : {t:'n', v:frac, z:"hh:mm"};
                    }
                }
            }
            
            // 4) Add number and date formats
            if(ws['!ref']){
                const range = XLSX.utils.decode_range(ws['!ref']);
                const numCols = BORAL_HEADERS
                    .map((h, i) => (["Density", "Mass Unit Vol", "Dim1", "Dim2", "Load Size", "Progress Load", "Des slmp", "Measured Slump", "Second Slump", "Avg Diameter", "Avg Height", "Strength", "Measured Air", "Concrete Temp", "Ambient Temp"].includes(h) ? i : -1))
                    .filter(i => i !== -1);
                    
                const dateCols = BORAL_HEADERS
                    .map((h, i) => (["Date", "Date Batched", "Date Tested"].includes(h) ? i : -1))
                    .filter(i => i !== -1);
                
                for(let r = range.s.r; r <= range.e.r; r++) {
                    for(let c = range.s.c; c <= range.e.c; c++) {
                        const cellAddress = XLSX.utils.encode_cell({r, c});
                        const cell = ws[cellAddress];
                        if (cell && cell.v !== null) {
                            if (numCols.includes(c)) {
                                const n = Number(cell.v);
                                if (!isNaN(n)) {
                                    cell.t = 'n';
                                    cell.v = n;
                                }
                            } else if (dateCols.includes(c)) {
                                const s = normalizeToDMYString(cell.v);
                                if (s) {
                                    const serial = dmyStringToSerial(s);
                                    if(serial != null){
                                        cell.t = 'n';
                                        cell.v = serial;
                                        cell.z = "dd/mm/yyyy";
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return ws;
        }

        function writeWB(sheets, name){
            const wb = XLSX.utils.book_new();
            for(const [title, ws] of sheets){
                XLSX.utils.book_append_sheet(wb, ws, title);
            }
            XLSX.writeFile(wb, name);
            state.filesExported++;
            state.lastExport = name;
            refreshKPI();
            addHistory(name);
            celebrate();
        }

        /* ===== Concrete mapping ===== */
        const S = {
            wr:["WR #","Work Request","WR"],
            docket:["Docket #","Docket","Ticket","Ticket #"],
            client:["Client Name","Client"],
            project:["Project Name","Project"],
            plant:["Plant"],
            sampledDate:["Sampled Date","Date Sampled","Date"],
            sampleId:["Sample #","Sample ID","SampleID"],
            sampleSuffix:["Sample (eg A,B,C)","Sample eg A,B,C","Sample (A/B/C)"],
            mould:["Mould Number","Mold Number"],
            class:["Class"],
            mix:["Supplier Mix Code","Mix Code","MixCode"],
            dateBatched:["Date Batched"],
            timeSampled:["Time Sampled"],
            timeBatched:["Time Batched"],
            timeMoulded:["Time Moulded"],
            dateTested:["Date Tested","Test Date"],
            ageDays:["Age Days","Age (days)","Age Day"],
            avgMPUV:["Average Mass per Unit Volume"],
            addMPUV:["Additional Mass per Unit Volume"],
            avgDiam:["Average Diameter","Avg Diameter","Diameter"],
            height:["Height of Specimen","Avg Height","Height"],
            loadSize:["Load size (m3)","Load Size"],
            progress:["Progress (m3)","Progress Load"],
            ordSlump:["Ordered Slump","Design Slump"],
            slump:["Slump","Measured Slump"],
            strength:["Strength","Compressive Strength"],
            compact:["Compact Method"],
            air:["Air Content","Measured Air","Air Cured"],
            concTemp:["Concrete Temp","Concrete Temperature"],
            ambTemp:["Ambient Temp","Ambient Temperature"],
            breakType:["Break Type","Failure Mode"],
            comments:["Comments","Worksheet Comments","Pour Location / Remarks","Remarks"],
            truck:["Truck #","Truck"],
            clientRef:["Client Ref. #","Client Ref #"],
            wrLocation:["Work Request Location","Sampling Location"," Worksheet Comments","Worksheet Comments"]
        };

        function buildConcreteBoral(rowsCyl, rowsField){
            const fieldMap = new Map();
            for(const r of rowsField){
                const key = String(getV(r,S.wr)||"").trim();
                if(!key) continue;
                if(!fieldMap.has(key)) fieldMap.set(key,{});
                const tgt = fieldMap.get(key);
                for(const k of Object.keys(r)){
                    const v = String(r[k]??"").trim();
                    if(v && !(k in tgt)) tgt[k]=v;
                }
            }

            const out=[];
            for(const r of rowsCyl){
                const wr = String(getV(r,S.wr)||"").trim();
                const f = fieldMap.get(wr)||{};
                const plant = first(getV(r,S.plant), f["Plant"]);
                const client = first(getV(r,S.client), f["Client"]);
                const project = first(getV(r,S.project), f["Project Name"]);
                const pourFromRef = first(...S.clientRef.map(k=>f[k]));
                const trFromText = first(
                    findTR(getV(r,S.comments)),
                    findTR(f["Worksheet Comments"]),
                    findTR(f["Sampling Location"])
                );
                const pourNo = first(pourFromRef, trFromText, (wr? `TR ${wr}`: "") );
                const sampleNo = getV(r,S.sampleId) || "";
                const sampleSuf = getV(r,S.sampleSuffix) || "";
                const mould = getV(r,S.mould) || "";
                const sampleID = sampleNo || mould;
                const specID = (sampleNo? (sampleNo + (sampleSuf||"")) : mould);

                const density = (getV(r,S.avgMPUV) ? intOrBlank(getV(r,S.avgMPUV)) : "");
                const muvol = (getV(r,S.addMPUV) ? intOrBlank(getV(r,S.addMPUV)) : "");
                const strength= (getV(r,S.strength) ? numOrBlank(getV(r,S.strength)) : "");

                const avgDia = numOrBlank(getV(r,S.avgDiam));
                const height = numOrBlank(getV(r,S.height));
                const loadSz = numOrBlank(getV(r,S.loadSize));
                const progLd = numOrBlank(getV(r,S.progress));
                const desSl = numOrBlank(first(getV(r,S.ordSlump), f["Ordered Slump"]));
                const measSl = numOrBlank(first(getV(r,S.slump), f["Slump"]));

                // FIXED: Use temperature-specific function for temps
                const cTemp = numOrBlankTemp(first(getV(r,S.concTemp), f["Concrete Temperature"]));
                const aTemp = numOrBlankTemp(first(getV(r,S.ambTemp), f["Ambient Temperature"]));

                const docketStr = first(getV(r,S.docket), f["Docket #"]);
                const truckFromField = first(f["Truck"], f["Truck #"]);
                const remarksFromField = first(f["Remarks"], f["Worksheet Comments"], f["Pour Location / Remarks"]);

                const row = {
                    "Date": first(getV(r,S.sampledDate), f["Date Sampled"]),
                    "Source Code": mapSourceCode(plant),
                    "Docket": docketStr,
                    "ClientName": client,
                    "ProjectName": project,
                    "PourNo": pourNo,
                    "Lots": "",
                    "SampleID": sampleID,
                    "Specimen ID": specID,
                    "Type": first(getV(r,S.class)) || "COMP100",
                    "Product Code": first(getV(r,S.mix), f["Supplier Mix Code"]),
                    "Date Batched": first(getV(r,S.dateBatched)),
                    "Time Sampled": first(getV(r,S.timeSampled)),
                    "Time Batched": first(getV(r,S.timeBatched)),
                    "Time Moulded": first(getV(r,S.timeMoulded)),
                    "Date Tested": first(getV(r,S.dateTested)),
                    "Age Days": intOrBlank(getV(r,S.ageDays)),
                    "Age Hours": "",
                    "Init Curing Hrs": "",
                    "Std Curing Days": "",
                    "Grade": "",
                    "Density": density,
                    "Mass Unit Vol": muvol,
                    "Dim1": avgDia,
                    "Dim2": height,
                    "Load Size": loadSz,
                    "Progress Load": progLd,
                    "Des slmp": desSl,
                    "Measured Slump": measSl,
                    "Second Slump": "",
                    "Avg Diameter": avgDia,
                    "Avg Height": height,
                    "Strength": strength,
                    "Compact Method": first(getV(r,S.compact)),
                    "Measured Air": (getV(r,S.air) ? numOrBlank(getV(r,S.air)) : ""),
                    "Concrete Temp": cTemp,
                    "Ambient Temp": aTemp,
                    "Failure Mode": first(getV(r,S.breakType)),
                    "Cap": first(getV(r,S.mould)) ? String(getV(r,S.mould)) : "",
                    "Marks": "",
                    "Location Description": String(first(
                        f["Pour Location / Remarks"],
                        f["Worksheet Comments"],
                        f["Sampling Location"],
                        getV(r,S.comments)
                    )||"").trim(),
                    "Truck": first(truckFromField, getV(r,S.truck)),
                    "Remarks": first(remarksFromField, getV(r,S.comments), f["Sampling Location"]),
                    "Rounded Density (U)": (density==="" ? "" : round10UpOrBlank(density)),
                    "Rounded MPUV (V)": (muvol==="" ? "" : intOrBlank(muvol)),
                    "Rounded Strength (AE)": (strength==="" ? "" : round1OrBlank(strength))
                };
                out.push(row);
            }
            return out;
        }

        /* ===== Grout mapping + SC inference ===== */
        const G = {
            wr:["WR #","Work Request","WR"],
            docket:["Docket #","Docket","Ticket","Ticket #"],
            client:["Client Name","Client"],
            project:["Project Name","Project"],
            sampledDate:["Sampled Date","Date Sampled","Date"],
            timeSampled:["Time Sampled"],
            timeBatched:["Time Batched"],
            timeMoulded:["Time Moulded"],
            dateTested:["Date Tested","Test Date"],
            ageDays:["Age Days","Age (days)","Age Day"],
            sampleId:["Sample #","Sample ID","SampleID"],
            sampleSuffix:["Sample (eg A,B,C)","Sample eg A,B,C","Sample (A/B/C)"],
            mix:["Supplier Mix Code","Mix Code","MixCode"],
            avgMPUV:["Average Mass per Unit Volume"],
            addMPUV:["Additional Mass per Unit Volume"],
            avgDiam:["Average Diameter","Avg Diameter","Diameter"],
            height:["Height of Specimen","Avg Height","Height"],
            loadSize:["Load size (m3)","Load size (m³)","Load Size"],
            progress:["Progress (m3)","Progress (m³)","Progress Load"],
            conc:["Consistency"],
            concTemp:["Concrete Temp","Concrete Temperature"],
            ambTemp:["Ambient Temp","Ambient Temperature"],
            failure:["Break Type","Failure Mode"],
            grade:["Grade"],
            mould:["Mould Number","Mold Number"],
            remarks:["Comments"],
            locdesc:["Pour Location / Remarks","Work Request Location","Sampling Location"],
            truck:["Truck #","Truck"],
            exportClientRef:["Client Ref. #","Client Ref #"]
        };

        const MAP_TAN=[/\bR19(2[1-9]|30)\b/i,/\bTBM3\b/i,/\bHRT-?01\b/i,/Intake\s*C3\s*Grout\s*Testing/i,/S2-CIV-HT-HTU-LOT/i,/S2-CIV-IG-TNI-LOT/i,/Grout\s*Plant[_\s]?32/i,/Completion\s*of\s*Backfill/i];
        const MAP_MAR=[/Marica\s*ADIT\s*Portal/i];
        const MAP_LOBS=[/\bJunction\b/i,/\bTalbingo\b/i,/\bTH\b|\bTransforming\s*Hall\b/i,/\bECV\b/i,/\bCTB\b/i,/\bMH\b|\bMachine\s*Hall\b/i,/\bPenstock\b/i,/\bTR1\b.*\bTBM2\b/i,/\bTalbingo\s*Junction\b/i,/\bDT0?3\b/i,/\bD&?B\b.*\bTunnel\b/i,/\bPenstock\s*5\b/i];
        const ONLY_TR=/^(?=.*\bTR\s*\d+\b)(?!.*(Junction|Talbingo|TBM3|HRT|R19|HT-HTU|IG-TNI|CT-MAD|SS-HSS|Marica|ADIT|Portal|ECV|CTB|Machine|Penstock|DT|D&?B|Tunnel|Grout\s*Plant|Intake|Completion)).*$/i;

        function inferGroutSourceIfMissing(existing, location, remarks){
            const sc = String(existing||"").trim();
            if(sc) return sc;
            const combined = `${String(location||"").trim()} ${String(remarks||"").trim()}`.trim();
            if(!combined) return "";
            if(ONLY_TR.test(combined)) return "";
            for(const rx of MAP_TAN){
                if(rx.test(combined)) return "TAN";
            }
            for(const rx of MAP_MAR){
                if(rx.test(combined)) return "MAR";
            }
            for(const rx of MAP_LOBS){
                if(rx.test(combined)) return "LOBS";
            }
            return "";
        }

        function buildGroutBoral(rowsCube, rowsExport){
            const mapRef = new Map();
            for(const r of rowsExport||[]){
                const wr = String(getV(r,G.wr)||"").trim();
                const pref = first(...G.exportClientRef.map(k=>r[k]));
                if(wr && pref && !mapRef.has(wr)) mapRef.set(wr, pref);
            }

            const out=[];
            for(const r of rowsCube){
                const wr = String(getV(r,G.wr)||"").trim();
                const sampleNo = getV(r,G.sampleId) || "";
                const sampleSuf = getV(r,G.sampleSuffix) || "";
                const specID = sampleNo + (sampleSuf||"");

                const density = (getV(r,G.avgMPUV) ? numOrBlank(getV(r,G.avgMPUV)) : "");
                const muvol = (getV(r,G.addMPUV) ? numOrBlank(getV(r,G.addMPUV)) : "");
                const strength = (("Strength" in r) ? numOrBlank(r["Strength"]) : "");

                const avgDia = numOrBlank(getV(r,G.avgDiam));
                const height = numOrBlank(getV(r,G.height));
                const loadSz = numOrBlank(getV(r,G.loadSize));
                const progLd = numOrBlank(getV(r,G.progress));
                const measSl = numOrBlank(getV(r,G.conc));

                // FIXED: Use temperature-specific function for temps
                const cTemp = numOrBlankTemp(getV(r,G.concTemp));
                const aTemp = numOrBlankTemp(getV(r,G.ambTemp));

                const sampledTxt = first(getV(r,G.sampledDate));
                const testedTxt = first(getV(r,G.dateTested));

                const baseLoc = first(getV(r,G.locdesc), getV(r,G.remarks)).trim();
                const builtLoc = (()=>{
                    const date1 = normalizeToDMYString(sampledTxt);
                    const date2 = normalizeToDMYString(testedTxt);
                    const age = intOrBlank(getV(r,G.ageDays));
                    const parts = [];
                    if(baseLoc) parts.push(baseLoc);
                    if(measSl!=="") parts.push(`${measSl}`);
                    const segs = [];
                    if(date1) segs.push(`Grout Testing ${date1}`);
                    if(age!=="") segs.push(`${age}`);
                    if(date2) segs.push(`Grout Testing ${date2}`);
                    if(segs.length) parts.push(segs.join("_ "));
                    return parts.join("_ ");
                })();

                const docketStr = first(getV(r,G.docket));
                const remarksTxt = first(getV(r,G.remarks));
                const existingSC = first(r["Source Code"]);
                const inferredSC = inferGroutSourceIfMissing(existingSC, builtLoc, remarksTxt);

                const row = {
                    "Date": normalizeToDMYString(sampledTxt),
                    "Source Code": inferredSC,
                    "Docket": docketStr,
                    "ClientName": first(getV(r,G.client)),
                    "ProjectName": first(getV(r,G.project)),
                    "PourNo": (mapRef.get(wr) || ""),
                    "Lots": "",
                    "SampleID": sampleNo,
                    "Specimen ID": specID,
                    "Type": "",
                    "Product Code": first(getV(r,G.mix)),
                    "Date Batched": normalizeToDMYString(sampledTxt),
                    "Time Sampled": first(getV(r,G.timeSampled)),
                    "Time Batched": first(getV(r,G.timeBatched)),
                    "Time Moulded": first(getV(r,G.timeMoulded)),
                    "Date Tested": normalizeToDMYString(testedTxt),
                    "Age Days": intOrBlank(getV(r,G.ageDays)),
                    "Age Hours": "",
                    "Init Curing Hrs": "",
                    "Std Curing Days": "",
                    "Grade": first(getV(r,G.grade)) || "",
                    "Density": density,
                    "Mass Unit Vol": muvol,
                    "Dim1": avgDia,
                    "Dim2": height,
                    "Load Size": loadSz,
                    "Progress Load": progLd,
                    "Des slmp": "",
                    "Measured Slump": measSl,
                    "Second Slump": "",
                    "Avg Diameter": avgDia,
                    "Avg Height": height,
                    "Strength": strength,
                    "Compact Method": "",
                    "Measured Air": "",
                    "Concrete Temp": cTemp,
                    "Ambient Temp": aTemp,
                    "Failure Mode": first(getV(r,G.failure)),
                    "Cap": "",
                    "Marks": first(getV(r,G.mould)),
                    "Location Description": builtLoc,
                    "Truck": "",
                    "Remarks": remarksTxt,
                    "Rounded Density (U)": (density==="" ? "" : round10UpOrBlank(density)),
                    "Rounded MPUV (V)": (muvol==="" ? "" : intOrBlank(muvol)),
                    "Rounded Strength (AE)": (strength==="" ? "" : round1OrBlank(strength))
                };
                out.push(row);
            }
            return out;
        }

        /* ===== Weekly helpers ===== */
        function normalizeRowDatesToDMY(r){
            const z={...r};
            ["Date","Date Batched","Date Tested"].forEach(k=>{
                z[k]=normalizeToDMYString(z[k]);
            });
            return z;
        }

        function isTempRow(r){
            const hasPour = String(r["PourNo"]||"").trim()!=="";
            const ct = r["Concrete Temp"];
            const at = r["Ambient Temp"];
            // Only consider it a temp row if there are actual non-zero temperature values
            const hasTemp = (ct !== "" && ct !== null && ct !== undefined && ct !== 0 && ct !== "0") ||
                            (at !== "" && at !== null && at !== undefined && at !== 0 && at !== "0");
            return hasPour && hasTemp;
        }

        function dedupeTemp(rows){
            const seenPour = new Set(), pass1=[];
            for(const r of rows){
                const p=String(r["PourNo"]||"").trim();
                if(p){
                    if(!seenPour.has(p)){seenPour.add(p); pass1.push(r);}
                } else pass1.push(r);
            }

            const seen = new Set(), out=[];
            for(const r of pass1){
                const k=[normalizeToDMYString(r["Date"]), String(r["PourNo"]||"").trim(), String(r["Age Days"]||"").trim(), String(r["Type"]||"").trim(), String(r["Product Code"]||"").trim()].join("|");
                if(!seen.has(k)){
                    seen.add(k);
                    out.push(r);
                }
            }
            return out;
        }

        function autoFillMissingSourceCodes(rows){
            let filled = 0;
            for(const r of rows){
                const current = String(r["Source Code"]||"").trim();
                if(current) continue;

                const loc = r["Location Description"] || "";
                const rem = r["Remarks"] || "";
                const inferred = inferGroutSourceIfMissing("", loc, rem);
                if(inferred){
                    r["Source Code"] = inferred;
                    filled++;
                }
            }
            return filled;
        }

        function tempRowsToSheet(rows){
            const out = rows.map(r=>({
                "Date": normalizeToDMYString(r["Date"]),
                "Source Code": r["Source Code"]||"",
                "Docket": r["Docket"]||"",
                "PourNo": r["PourNo"]||"",
                "Type": r["Type"]||"",
                "Product Code": r["Product Code"]||"",
                "Date Batched": normalizeToDMYString(r["Date Batched"]) || normalizeToDMYString(r["Date"]),
                "Age Days": (r["Age Days"]!==""? intOrBlank(r["Age Days"]) : ""),
                "Concrete Temp": (r["Concrete Temp"]!==""? numOrBlankTemp(r["Concrete Temp"]) : ""),
                "Ambient Temp": (r["Ambient Temp"]!==""? numOrBlankTemp(r["Ambient Temp"]) : ""),
                "Location Description": r["Location Description"]||""
            }));

            const ws = XLSX.utils.json_to_sheet(out, {header: TEMP_HEADERS, raw:true});

            const dateCols = ["Date","Date Batched"].map(h=> TEMP_HEADERS.indexOf(h)).filter(i=>i>=0);
            if(ws['!ref']){
                const range = XLSX.utils.decode_range(ws['!ref']);
                for(const ci of dateCols){
                    for(let r = range.s.r+1; r <= range.e.r; r++){
                        const addr = XLSX.utils.encode_cell({r, c:ci});
                        const s = (ws[addr] && ws[addr].v != null) ? String(ws[addr].v).trim() : "";
                        if(!s){
                            ws[addr] = { t:'s', v:"" };
                            continue;
                        }
                        const serial = dmyStringToSerial(s);
                        ws[addr] = (serial==null) ? { t:'s', v:s } : { t:'n', v:serial, z:"dd/mm/yyyy" };
                    }
                }
            }
            return ws;
        }

        /* ================= UI wiring (drag & drop + clicks) ================= */
        function wireDrop(zoneId, fileInputId, badgeId){
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(fileInputId);

            zone.addEventListener('click', ()=> input.click());

            ;['dragenter','dragover'].forEach(ev=>
                zone.addEventListener(ev, e=>{
                    e.preventDefault();
                    e.stopPropagation();
                    zone.classList.add('dragover');
                }));

            ;['dragleave','drop'].forEach(ev=>
                zone.addEventListener(ev, e=>{
                    e.preventDefault();
                    e.stopPropagation();
                    zone.classList.remove('dragover');
                }));

            zone.addEventListener('drop', e=>{
                const f = e.dataTransfer.files[0];
                if(f){
                    input.files = e.dataTransfer.files;
                    if(badgeId) badge(badgeId, f.name, 'ok');
                    onFileChange();
                }
            });

            input.addEventListener('change', ()=>{
                if(badgeId) badge(badgeId, input.files[0]?.name || 'Waiting for files', input.files[0]?'ok':'warn');
                onFileChange();
            });
        }

        function badge(id,t,cls){
            const el=document.getElementById(id);
            if(el){
                el.textContent=t;
                el.className='badge '+(cls||'');
            }
        }

        function onFileChange(){
            document.getElementById('btn-conc').disabled = !(document.getElementById('f-cyl').files[0] && document.getElementById('f-field').files[0]);
            document.getElementById('btn-grout').disabled = !document.getElementById('f-cube').files[0];
        }

        wireDrop('drop-cyl','f-cyl','b-cyl');
        wireDrop('drop-field','f-field','b-field');
        wireDrop('drop-cube','f-cube','b-cube');
        wireDrop('drop-gse','f-gse','b-gse');

        // Added drag-and-drop wiring for weekly section
        wireDrop('drop-boralc', 'f-boralc', 'b-boralc');
        wireDrop('drop-boralg', 'f-boralg', 'b-boralg');
        wireDrop('drop-lobs', 'f-lobs', 'b-lobs');
        wireDrop('drop-polo', 'f-polo', 'b-polo');


        /* ================= Buttons: build files ================= */
        const logA = (m)=>{
            const el=document.getElementById('logA');
            el.textContent += '\n'+m;
            el.scrollTop=el.scrollHeight;
            const mir=document.getElementById('logA_mirror');
            if(mir){
                mir.textContent = el.textContent;
                mir.scrollTop=mir.scrollHeight;
            }
        };

        const logB = (m)=>{
            const el=document.getElementById('logB');
            el.textContent += '\n'+m;
            el.scrollTop=el.scrollHeight;
            const mir=document.getElementById('logB_mirror');
            if(mir){
                mir.textContent = el.textContent;
                mir.scrollTop=mir.scrollHeight;
            }
        };

        document.getElementById('btn-conc').addEventListener('click', async ()=>{
            try{
                const f1 = document.getElementById('f-cyl').files[0];
                const f2 = document.getElementById('f-field').files[0];
                if(!f1 || !f2){
                    // Replaced alert with a custom message box
                    alert('Please add both files.');
                    return;
                }

                showOverlay('Reading Concrete files...');
                setProgress(10);

                const [rowsCyl, rowsField] = await Promise.all([loadAny(f1), loadAny(f2)]);

                setProgress(35,'Mapping to Boral format...');
                const mapped = buildConcreteBoral(rowsCyl, rowsField);
                state.concreteCount += mapped.length;
                state.processedRows += mapped.length;

                setProgress(65,'Converting dates & generating Excel...');
                // Using the updated function to handle data types
                const ws = rowsToSheet_withTimeFix(mapped);

                setProgress(85,'Finalizing download...');
                writeWB([["Boral", ws]], "Concrete_Boral.xlsx");

                setProgress(100,'Complete!');
                hideOverlay();
                logA('✅ Concrete_Boral.xlsx generated successfully ('+mapped.length+' rows processed)');
                refreshKPI();
            }catch(e){
                console.error(e);
                hideOverlay();
                alert('Concrete processing error: '+(e.message||e));
            }
        });

        document.getElementById('btn-grout').addEventListener('click', async ()=>{
            try{
                const f1 = document.getElementById('f-cube').files[0];
                const f2 = document.getElementById('f-gse').files[0];

                showOverlay('Reading Grout files...');
                setProgress(10);

                const [rowsCube, rowsExport] = await Promise.all([loadAny(f1), loadAny(f2)]);

                setProgress(35,'Mapping to Boral format...');
                const mapped = buildGroutBoral(rowsCube||[], rowsExport||[]);
                state.groutCount += mapped.length;
                state.processedRows += mapped.length;

                setProgress(65,'Converting dates & generating Excel...');
                // Using the updated function to handle data types
                const ws = rowsToSheet_withTimeFix(mapped);

                setProgress(85,'Finalizing download...');
                writeWB([["Boral", ws]], "Grout_Boral.xlsx");

                setProgress(100,'Complete!');
                hideOverlay();
                logA('✅ Grout_Boral.xlsx generated successfully ('+mapped.length+' rows processed)');
                refreshKPI();
            }catch(e){
                console.error(e);
                hideOverlay();
                alert('Grout processing error: '+(e.message||e));
            }
        });

        /* ================= Weekly (B) - FIXED DATE FILTERING ================= */
        function markBadge(inputId, badgeId){
            const f=document.getElementById(inputId).files[0];
            badge(badgeId, f?f.name:'No file selected', f?'ok':'');
        }

        ['f-boralc','f-boralg','f-lobs','f-polo'].forEach(id=>
            document.getElementById(id).addEventListener('change', ()=>{
                if(id==='f-boralc') markBadge('f-boralc','b-boralc');
                if(id==='f-boralg') markBadge('f-boralg','b-boralg');
                if(id==='f-lobs') markBadge('f-lobs','b-lobs');
                if(id==='f-polo') markBadge('f-polo','b-polo');
            }));

        document.getElementById('btn-weekly').addEventListener('click', async ()=>{
            try{
                logB("📊 Initializing weekly report generation...");
                const [cBoral,gBoralRaw,lobsAll,poloAll]=await Promise.all([
                    document.getElementById('f-boralc').files[0]?loadAny(document.getElementById('f-boralc').files[0]):[],
                    document.getElementById('f-boralg').files[0]?loadAny(document.getElementById('f-boralg').files[0]):[],
                    document.getElementById('f-lobs').files[0]?loadAny(document.getElementById('f-lobs').files[0]):[],
                    document.getElementById('f-polo').files[0]?loadAny(document.getElementById('f-polo').files[0]):[]
                ]);

                // Remove all Docket numbers from GROUT input (set to blank)
                const gBoral = gBoralRaw.map(r => {
                    const z = {...r};
                    z["Docket"] = ""; // ensure Docket is blank for all grout rows
                    return z;
                });

                const all=[...cBoral,...gBoral,...lobsAll,...poloAll];
                logB("📈 Total input rows: "+all.length);

                const startDate=dateFromInput(document.getElementById('b-start').value);
                const endDate=dateFromInput(document.getElementById('b-end').value);

                // FIXED: Improved date filtering logic
                const beforeCount=all.length;
                const filtered=all.filter(row=>{
                    // If no date range specified, include all rows
                    if(!startDate && !endDate) return true;
                    
                    const d=getPivotDateDMY(row);
                    // If no valid date found in row, exclude it when filtering is active
                    if(!d && (startDate || endDate)) return false;
                    // If no valid date but no filtering, include it
                    if(!d) return true;
                    
                    // Apply date range filtering
                    if(startDate && d < startDate) return false;
                    if(endDate && d > endDate) return false;
                    return true;
                });

                const rangeText = (startDate || endDate) ?
                    `📅 Date Range: ${document.getElementById('b-start').value||'∞'} → ${document.getElementById('b-end').value||'∞'}` :
                    "📅 Date Range: ALL DATA";
                logB(`${rangeText}`);
                logB(`🔍 Filtered: ${beforeCount} → ${filtered.length} rows`);

                const filledSC = autoFillSourceCodesAll(filtered);
                logB(`🏗️ Auto-filled ${filledSC} source codes`);

                // Type autofill (only blanks)
                const filledType = autoFillType(filtered);
                logB(`🔧 Auto-filled ${filledType} type classifications`);

                const wsMain = rowsToSheet_withTimeFix(filtered);
                writeWB([["All Sites (Main)",wsMain]],"All_Sites_Main_Data.xlsx");
                logB("✅ All_Sites_Main_Data.xlsx generated ("+filtered.length+" rows)");

                // Temperature Extract
                setProgress(85,'Building Temperature Extract...');
                const tempRows = (function dedupe(rows){
                    const isTemp = r => {
                        const hasPour = String(r["PourNo"]||"").trim()!=="";
                        const ct = r["Concrete Temp"];
                        const at = r["Ambient Temp"];
                        // Only consider it a temp row if there are actual non-zero temperature values
                        const hasTemp = (ct !== "" && ct !== null && ct !== undefined && ct !== 0 && ct !== "0") ||
                                        (at !== "" && at !== null && at !== undefined && at !== 0 && at !== "0");
                        return hasPour && hasTemp;
                    };
                    const pass = rows.filter(isTemp);

                    const seenPour = new Set(), pass1=[];
                    for(const r of pass){
                        const p=String(r["PourNo"]||"").trim();
                        if(p){
                            if(!seenPour.has(p)){seenPour.add(p); pass1.push(r);}
                        } else pass1.push(r);
                    }

                    const seen = new Set(), out=[];
                    for(const r of pass1){
                        const k=[normalizeToDMYString(r["Date"]), String(r["PourNo"]||"").trim(), String(r["Age Days"]||"").trim(), String(r["Type"]||"").trim(), String(r["Product Code"]||"").trim()].join("|");
                        if(!seen.has(k)){
                            seen.add(k);
                            out.push(r);
                        }
                    }
                    return out;
                })(filtered);

                const wsTempMain = tempRowsToSheet(tempRows);

                // Build site-specific temperature sheets
                const bySite = {
                    TAN: tempRows.filter(r=>{
                        const pn = String(r["ProjectName"]||"");
                        const sc = String(r["Source Code"]||"");
                        return /Tantangara/i.test(pn) || /\bTAN\b/i.test(sc);
                    }),
                    MAR: tempRows.filter(r=>{
                        const pn = String(r["ProjectName"]||"");
                        const sc = String(r["Source Code"]||"");
                        return /Marica/i.test(pn) || /\bMAR\b/i.test(sc);
                    }),
                    POLO: tempRows.filter(r=>{
                        const pn = String(r["ProjectName"]||"");
                        const sc = String(r["Source Code"]||"");
                        return /Polo\s*Flat/i.test(pn) || /\bPOLO\b/i.test(sc);
                    }),
                    LOBS: tempRows.filter(r=>{
                        const pn = String(r["ProjectName"]||"");
                        const sc = String(r["Source Code"]||"");
                        return /Lobs\s*Hole/i.test(pn) || /\bLOBS?\b/i.test(sc);
                    })
                };

                const wsT = tempRowsToSheet(bySite.TAN);
                const wsM = tempRowsToSheet(bySite.MAR);
                const wsP = tempRowsToSheet(bySite.POLO);
                const wsL = tempRowsToSheet(bySite.LOBS);

                writeWB([["Main (Temperature)", wsTempMain], ["TAN", wsT], ["POLO", wsP], ["MAR", wsM], ["LOBS", wsL]], "Temperature_Extract.xlsx");

                logB(`🎉 Weekly reports completed successfully!`);
                logB(`📊 Main data: ${filtered.length} rows | Temperature data: ${tempRows.length} rows`);
                logB(`${rangeText}`);
                state.processedRows += filtered.length;
                refreshKPI();
            }catch(e){
                console.error(e);
                alert("Weekly processing error: "+e.message);
            }
        });
    </script>
</body>
</html>
